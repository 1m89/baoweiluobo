<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>ğŸ¥• ä¿å«èåœ</title>
<style>
:root{--gold:#FFD700;--red:#FF4757;--green:#2ED573;--blue:#3498db;--purple:#9B59B6}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none}
html,body{width:100%;height:100%;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif}
body{background:#0a0a15;display:flex;align-items:center;justify-content:center}

#app{position:relative;width:100%;height:100%;max-width:100%;display:flex;flex-direction:column;overflow:hidden}

/* é¡¶éƒ¨æ  */
#topBar{
height:52px;min-height:52px;
background:linear-gradient(180deg,#1a1a2e 0%,#16162a 100%);
display:flex;align-items:center;justify-content:space-between;
padding:0 12px;padding-top:env(safe-area-inset-top);
border-bottom:1px solid rgba(255,255,255,0.1);
box-shadow:0 2px 10px rgba(0,0,0,0.3);
flex-shrink:0;z-index:10;
}
.stats{display:flex;gap:12px;align-items:center}
.stat{
display:flex;align-items:center;gap:5px;
background:rgba(255,255,255,0.08);
padding:6px 12px;border-radius:20px;
font-size:14px;font-weight:600;color:#fff;
border:1px solid rgba(255,255,255,0.1);
}
.stat .icon{font-size:16px}
.stat .val{color:var(--gold);min-width:30px;text-align:right}
#ctrlBtns{display:flex;gap:6px}
.cBtn{
width:38px;height:38px;border-radius:10px;border:none;
background:rgba(255,255,255,0.1);color:#fff;font-size:14px;
cursor:pointer;transition:all 0.2s;
display:flex;align-items:center;justify-content:center;
}
.cBtn:active{transform:scale(0.95)}
.cBtn.on{background:var(--gold);color:#000}

/* æ¸¸æˆåŒºåŸŸ */
#gameWrap{flex:1;position:relative;overflow:hidden;background:#1a1a2e}
#canvas{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);border-radius:8px;box-shadow:0 0 30px rgba(0,0,0,0.5)}

/* å…³å¡ä¿¡æ¯ */
#lvlInfo{
position:absolute;top:10px;left:10px;
background:rgba(0,0,0,0.7);backdrop-filter:blur(10px);
padding:8px 16px;border-radius:12px;
color:#fff;font-size:13px;font-weight:500;
border:1px solid rgba(255,255,255,0.15);
z-index:5;
}
#lvlInfo .name{color:var(--gold);font-weight:700}

/* æŠ€èƒ½æ  */
#skillPanel{
position:absolute;right:10px;top:50%;transform:translateY(-50%);
display:flex;flex-direction:column;gap:10px;z-index:5;
}
.skillBtn{
width:52px;height:52px;border-radius:14px;
background:linear-gradient(145deg,#2a2a4a,#1a1a3a);
border:2px solid rgba(255,255,255,0.2);
display:flex;align-items:center;justify-content:center;
font-size:24px;cursor:pointer;position:relative;
box-shadow:0 4px 15px rgba(0,0,0,0.3);
transition:all 0.2s;
}
.skillBtn:active{transform:scale(0.95)}
.skillBtn.ready{border-color:var(--green);box-shadow:0 0 20px rgba(46,213,115,0.4)}
.skillBtn .cdFill{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.7);border-radius:0 0 12px 12px;transition:height 0.1s}
.skillBtn .cost{
position:absolute;bottom:-6px;right:-6px;
background:var(--gold);color:#000;
font-size:10px;font-weight:700;
padding:2px 6px;border-radius:10px;
}

/* è¿å‡» */
#comboBox{
position:absolute;top:10px;right:10px;
background:linear-gradient(135deg,#ff4757,#ff6b81);
padding:8px 16px;border-radius:12px;
color:#fff;font-size:16px;font-weight:700;
opacity:0;transition:all 0.3s;z-index:5;
box-shadow:0 4px 15px rgba(255,71,87,0.4);
}
#comboBox.show{opacity:1}

/* åº•éƒ¨å»ºé€ æ  */
#buildBar{
height:95px;min-height:95px;
background:linear-gradient(180deg,#1a1a2e,#12121f);
display:flex;align-items:center;justify-content:center;gap:8px;
padding:10px 15px;padding-bottom:calc(10px + env(safe-area-inset-bottom));
border-top:1px solid rgba(255,255,255,0.1);
flex-shrink:0;z-index:10;
}
.towerCard{
width:68px;height:75px;border-radius:14px;
background:linear-gradient(180deg,#2a2a4a 0%,#1a1a3a 100%);
border:2px solid rgba(255,255,255,0.15);
display:flex;flex-direction:column;align-items:center;justify-content:center;
cursor:pointer;transition:all 0.2s;position:relative;
box-shadow:0 4px 10px rgba(0,0,0,0.2);
}
.towerCard:active{transform:scale(0.95)}
.towerCard.selected{
border-color:var(--gold);
box-shadow:0 0 25px rgba(255,215,0,0.5);
background:linear-gradient(180deg,#3a3a5a 0%,#2a2a4a 100%);
}
.towerCard.disabled{opacity:0.35;pointer-events:none}
.towerCard .tIcon{font-size:28px;margin-bottom:2px}
.towerCard .tCost{font-size:12px;color:var(--gold);font-weight:700}
.towerCard .tName{font-size:9px;color:rgba(255,255,255,0.6)}

/* æ“ä½œé¢æ¿ */
#actPanel{
position:absolute;display:none;
background:rgba(15,15,30,0.95);backdrop-filter:blur(10px);
padding:12px;border-radius:16px;
border:2px solid rgba(255,215,0,0.3);
box-shadow:0 8px 30px rgba(0,0,0,0.5);
gap:10px;z-index:50;
}
.actBtn{
width:52px;height:52px;border-radius:50%;
border:2px solid rgba(255,255,255,0.3);
display:flex;flex-direction:column;align-items:center;justify-content:center;
font-size:20px;cursor:pointer;color:#fff;transition:all 0.15s;
}
.actBtn:active{transform:scale(0.9)}
.actBtn.upg{background:linear-gradient(180deg,#3498db,#2980b9)}
.actBtn.abl{background:linear-gradient(180deg,#9b59b6,#8e44ad)}
.actBtn.sel{background:linear-gradient(180deg,#e74c3c,#c0392b)}
.actBtn span{font-size:9px;margin-top:2px;font-weight:600}

/* å¼¹çª—åŸºç¡€ */
.modal{
position:absolute;inset:0;
background:rgba(5,5,15,0.98);
display:flex;flex-direction:column;align-items:center;justify-content:center;
z-index:100;padding:20px;text-align:center;
}
.modal.hide{display:none}
.modal h1{
font-size:clamp(32px,8vw,48px);margin-bottom:15px;
background:linear-gradient(180deg,#FFD700,#FFA500);
-webkit-background-clip:text;-webkit-text-fill-color:transparent;
}
.modal p{color:rgba(255,255,255,0.7);margin-bottom:20px;font-size:15px}
.modalBtn{
padding:16px 45px;font-size:18px;border:none;border-radius:30px;
cursor:pointer;font-weight:700;margin:8px;transition:all 0.15s;
box-shadow:0 6px 0 rgba(0,0,0,0.3);
}
.modalBtn:active{transform:translateY(6px);box-shadow:none}
.modalBtn.primary{background:linear-gradient(180deg,#2ed573,#26ab5f);color:#fff}
.modalBtn.secondary{background:linear-gradient(180deg,#555,#333);color:#fff}

/* å…³å¡é€‰æ‹© */
#lvlGrid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin:20px 0;max-width:380px}
.lvlBtn{
padding:18px 12px;border-radius:14px;
background:linear-gradient(180deg,#2a2a4a,#1a1a3a);
border:2px solid rgba(255,255,255,0.15);
color:#fff;cursor:pointer;text-align:center;transition:all 0.2s;
}
.lvlBtn:active{transform:scale(0.95)}
.lvlBtn.locked{opacity:0.4;pointer-events:none}
.lvlBtn .num{font-size:26px;font-weight:800;color:var(--gold)}
.lvlBtn .lname{font-size:10px;color:rgba(255,255,255,0.6);margin-top:4px}
.lvlBtn .stars{font-size:14px;margin-top:6px}

/* éš¾åº¦é€‰æ‹© */
.diffBtns{display:flex;gap:12px;margin:18px 0;flex-wrap:wrap;justify-content:center}
.diffBtn{
padding:14px 22px;border-radius:12px;
background:rgba(255,255,255,0.08);border:2px solid rgba(255,255,255,0.15);
color:#fff;cursor:pointer;text-align:center;transition:all 0.2s;
}
.diffBtn:active{transform:scale(0.95)}
.diffBtn.sel{border-color:var(--gold);background:rgba(255,215,0,0.15)}
.diffBtn .dn{font-weight:700;font-size:15px}
.diffBtn .dd{font-size:10px;color:rgba(255,255,255,0.5);margin-top:3px}

/* æ³¢æ¬¡é¢„å‘Š */
#wavePop{
position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
background:rgba(10,10,25,0.98);backdrop-filter:blur(15px);
padding:25px 45px;border-radius:20px;
border:2px solid var(--gold);
text-align:center;display:none;z-index:60;
box-shadow:0 10px 40px rgba(0,0,0,0.6);
}
#wavePop h2{color:var(--gold);font-size:26px;margin-bottom:8px}
#wavePop p{color:rgba(255,255,255,0.7);font-size:13px}
#wavePop .enemies{display:flex;gap:12px;justify-content:center;margin-top:15px}
#wavePop .ei{font-size:36px}

/* Bossè­¦å‘Š */
#bossWarn{
position:absolute;inset:0;
background:radial-gradient(circle,rgba(255,0,0,0.15),rgba(255,0,0,0.3));
display:none;z-index:55;animation:bossF 0.2s infinite;
}
@keyframes bossF{0%,100%{opacity:0.6}50%{opacity:0.3}}
#bossWarn .txt{
position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
font-size:clamp(28px,8vw,45px);font-weight:800;color:#ff0000;
text-shadow:0 0 40px #ff0000,0 0 80px #ff0000;
}

/* äº‹ä»¶å¼¹çª— */
#eventPop{
position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
background:linear-gradient(180deg,rgba(100,0,150,0.95),rgba(60,0,100,0.95));
padding:20px 40px;border-radius:18px;border:2px solid #ff00ff;
text-align:center;display:none;z-index:58;
box-shadow:0 0 40px rgba(255,0,255,0.4);
}
#eventPop h3{color:#ff00ff;font-size:20px}
#eventPop p{color:rgba(255,255,255,0.8);font-size:13px;margin-top:6px}

/* æˆå°±å¼¹çª— */
#achPop{
position:absolute;top:60px;left:50%;transform:translateX(-50%) translateY(-120px);
background:linear-gradient(135deg,#FFD700,#FFA500);
padding:12px 25px;border-radius:12px;
font-weight:700;color:#000;font-size:15px;
box-shadow:0 6px 25px rgba(255,215,0,0.5);
transition:transform 0.4s cubic-bezier(0.68,-0.55,0.265,1.55);z-index:70;
}
#achPop.show{transform:translateX(-50%) translateY(0)}

/* æš‚åœèœå• */
#pauseMenu{
position:absolute;inset:0;background:rgba(5,5,15,0.98);
display:none;flex-direction:column;align-items:center;justify-content:center;z-index:90;
}
#pauseMenu h2{color:#fff;font-size:32px;margin-bottom:30px}

/* æµ®åŠ¨æ–‡å­— */
.floatTxt{
position:absolute;font-weight:700;pointer-events:none;
animation:fUp 0.8s forwards;text-shadow:2px 2px 4px rgba(0,0,0,0.5);z-index:30;
}
@keyframes fUp{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-45px) scale(0.7)}}
.dmgTxt{
position:absolute;font-weight:700;pointer-events:none;
animation:dUp 0.5s forwards;z-index:30;
}
@keyframes dUp{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-28px)}}

/* å¡”ä¿¡æ¯é¢æ¿ */
#towerInfo{
position:absolute;bottom:100px;left:10px;
background:rgba(0,0,0,0.85);backdrop-filter:blur(10px);
padding:12px 16px;border-radius:12px;
color:#fff;font-size:12px;font-weight:500;
border:1px solid rgba(255,255,255,0.15);
display:none;z-index:25;
max-width:180px;
}
#towerInfo h3{color:var(--gold);margin-bottom:5px;font-size:14px}
#towerInfo .stat{display:flex;justify-content:space-between;margin:3px 0}
#towerInfo .stat span:first-child{color:rgba(255,255,255,0.7)}
#towerInfo .stat span:last-child{color:#fff;font-weight:600}
</style>

</head>
<body>
<div id="app">
  <div id="topBar">
    <div class="stats">
      <div class="stat"><span class="icon">ğŸ’°</span><span class="val" id="vGold">300</span></div>
      <div class="stat"><span class="icon">â¤ï¸</span><span class="val" id="vLives">20</span></div>
      <div class="stat"><span class="icon">ğŸŒŠ</span><span class="val"><span id="vWave">0</span>/<span id="vMaxW">10</span></span></div>
      <div class="stat"><span class="icon">ğŸ’€</span><span class="val" id="vKills">0</span></div>
    </div>
    <div id="ctrlBtns">
      <button class="cBtn on" onclick="setSpd(1)">1x</button>
      <button class="cBtn" onclick="setSpd(2)">2x</button>
      <button class="cBtn" onclick="pause()">â¸ï¸</button>
    </div>
  </div>

  <div id="gameWrap">
    <canvas id="canvas"></canvas>
    <div id="lvlInfo"><span class="name" id="lvlName">ç¬¬1å…³: æ–°æ‰‹è‰åŸ</span></div>
    <div id="comboBox">ğŸ”¥ è¿å‡» x<span id="vCombo">0</span></div>
    <div id="skillPanel">
      <div class="skillBtn ready" onclick="useSkill(0)">âš¡<div class="cdFill" style="height:0"></div><span class="cost">50</span></div>
      <div class="skillBtn ready" onclick="useSkill(1)">â„ï¸<div class="cdFill" style="height:0"></div><span class="cost">40</span></div>
      <div class="skillBtn ready" onclick="useSkill(2)">ğŸ’°<div class="cdFill" style="height:0"></div><span class="cost">0</span></div>
    </div>
    <div id="actPanel">
      <div class="actBtn upg" onclick="doUpgrade()">â¬†ï¸<span id="upgCost">80</span></div>
      <div class="actBtn abl" onclick="doAbility()">âœ¨<span>æŠ€èƒ½</span></div>
      <div class="actBtn sel" onclick="doSell()">ğŸ’µ<span id="selVal">40</span></div>
    </div>
    <div id="wavePop"><h2>ç¬¬ <span id="waveN">1</span> æ³¢</h2><p id="waveD">å‡†å¤‡è¿æˆ˜!</p><div class="enemies" id="waveE"></div></div>
    <div id="bossWarn"><div class="txt">âš ï¸ BOSS âš ï¸</div></div>
    <div id="eventPop"><h3 id="evtT">äº‹ä»¶</h3><p id="evtD">æ•ˆæœ</p></div>
    <div id="achPop">ğŸ† æˆå°±è§£é”!</div>
    <div id="towerInfo"></div>
  </div>

  <div id="buildBar"></div>

  <div id="pauseMenu">
    <h2>â¸ï¸ æš‚åœ</h2>
    <button class="modalBtn primary" onclick="pause()">ç»§ç»­æ¸¸æˆ</button>
    <button class="modalBtn primary" onclick="G.retry()">é‡æ–°å¼€å§‹</button>
    <button class="modalBtn secondary" onclick="toMenu()">è¿”å›èœå•</button>
  </div>

  <div class="modal" id="menuScreen">
    <h1>ğŸ¥• ä¿å«èåœ</h1>
    <p>ç­–ç•¥å¡”é˜² Â· å¤šå…³å¡å†’é™©</p>
    <div class="diffBtns">
      <div class="diffBtn sel" onclick="setDiff(0)"><div class="dn">ğŸŒ± ç®€å•</div><div class="dd">æ¨èæ–°æ‰‹</div></div>
      <div class="diffBtn" onclick="setDiff(1)"><div class="dn">âš”ï¸ æ™®é€š</div><div class="dd">æ ‡å‡†æŒ‘æˆ˜</div></div>
      <div class="diffBtn" onclick="setDiff(2)"><div class="dn">ğŸ’€ å›°éš¾</div><div class="dd">çœŸæ­£è€ƒéªŒ</div></div>
    </div>
    <p style="font-size:12px;margin-top:10px">é€‰æ‹©å…³å¡å¼€å§‹æ¸¸æˆ</p>
    <div id="lvlGrid"></div>
  </div>

  <div class="modal hide" id="overScreen">
    <h1 style="background:linear-gradient(180deg,#ff4757,#c0392b);-webkit-background-clip:text">ğŸ’” æŒ‘æˆ˜å¤±è´¥</h1>
    <p>å‡»æ€: <span id="oKills">0</span> | åˆ°è¾¾: ç¬¬<span id="oWave">0</span>æ³¢</p>
    <button class="modalBtn primary" onclick="G.retry()">é‡æ–°æŒ‘æˆ˜</button>
    <button class="modalBtn secondary" onclick="toMenu()">è¿”å›èœå•</button>
  </div>

  <div class="modal hide" id="winScreen">
    <h1>ğŸ‰ èƒœåˆ©!</h1>
    <p>å‡»æ€: <span id="wKills">0</span> | å‰©ä½™ç”Ÿå‘½: <span id="wLives">0</span></p>
    <p style="font-size:32px;margin:15px 0" id="wStars">â­â­â­</p>
    <button class="modalBtn primary" onclick="nextLvl()">ä¸‹ä¸€å…³ â¡ï¸</button>
    <button class="modalBtn secondary" onclick="toMenu()">è¿”å›èœå•</button>
  </div>
</div>

<script>
// ä¼˜åŒ–åçš„å¡”æ•°æ®
const TOWERS={
  bottle:{n:'ç“¶å­ç‚®',i:'ğŸ”«',c:120,r:130,d:35,rt:28,t:'single',cr:.15,desc:'å•ä½“æ”»å‡»,æœ‰å‡ ç‡æš´å‡»'},
  fan:{n:'é£æ‰‡å¡”',i:'ğŸŒ€',c:160,r:145,d:22,rt:20,t:'pierce',pc:3,desc:'ç©¿é€æ”»å‡»,å¯æ‰“å‡»å¤šä¸ªæ•Œäºº'},
  ice:{n:'å†°æ˜Ÿå¡”',i:'â„ï¸',c:200,r:120,d:18,rt:38,t:'slow',sl:.35,desc:'å‡é€Ÿæ•Œäºº,æ§åˆ¶æ•ˆæœå¼º'},
  fire:{n:'ç«ç„°å¡”',i:'ğŸ”¥',c:240,r:95,d:15,rt:8,t:'aoe',ao:55,desc:'èŒƒå›´ä¼¤å®³,é€‚åˆç¾¤ä½“æ•Œäºº'},
  cannon:{n:'å¤§ç‚®å¡”',i:'ğŸ’£',c:280,r:155,d:85,rt:65,t:'splash',sp:45,desc:'æº…å°„ä¼¤å®³,èŒƒå›´ä¸­ç­‰'},
  magic:{n:'é­”æ³•å¡”',i:'ğŸ”®',c:350,r:140,d:50,rt:42,t:'chain',ch:4,desc:'è¿é”æ”»å‡»,æœ€å¤šæ‰“å‡»4ä¸ªç›®æ ‡'}
};

// ä¼˜åŒ–åçš„æ•Œäººæ•°æ® - æ›´åŠ åˆ†æ˜
const ENEMIES={
  normal:{i:'ğŸ‘¾',h:120,s:.7,w:15,desc:'æ™®é€šæ•Œäºº,å±æ€§å‡è¡¡'},
  fast:{i:'ğŸ°',h:75,s:1.4,w:18,desc:'å¿«é€Ÿæ•Œäºº,ç”Ÿå‘½å€¼ä½ä½†é€Ÿåº¦å¿«'},
  tank:{i:'ğŸ¢',h:550,s:.35,w:40,desc:'å¦å…‹æ•Œäºº,ç”Ÿå‘½å€¼é«˜ä½†é€Ÿåº¦æ…¢'},
  healer:{i:'ğŸ’š',h:140,s:.6,w:30,hl:1,desc:'æ²»ç–—æ•Œäºº,å¯æ¢å¤å…¶ä»–æ•Œäººç”Ÿå‘½'},
  split:{i:'ğŸ¦ ',h:160,s:.75,w:25,sp:1,desc:'åˆ†è£‚æ•Œäºº,æ­»äº¡ååˆ†è£‚æˆä¸¤ä¸ªå°æ•Œäºº'},
  ghost:{i:'ğŸ‘»',h:95,s:.9,w:35,gh:1,desc:'å¹½çµæ•Œäºº,æœ‰å‡ ç‡èº²é¿æ”»å‡»'},
  boss:{i:'ğŸ‘¹',h:3500,s:.3,w:300,bs:1,desc:'BOSSæ•Œäºº,ç”Ÿå‘½å€¼æé«˜'}
};

const LEVELS=[
  {n:'æ–°æ‰‹è‰åŸ',w:12,p:[[0,2],[3,2],[3,4],[7,4],[7,2],[10,2]],e:['normal','fast'],b:[12],th:'grass'},
  {n:'å¯’å†°å³¡è°·',w:14,p:[[0,1],[2,1],[2,4],[5,4],[5,1],[8,1],[8,3]],e:['normal','fast','tank'],b:[14],th:'ice'},
  {n:'ç†”å²©æ´ç©´',w:16,p:[[0,3],[2,3],[2,1],[6,1],[6,4],[9,4]],e:['normal','fast','tank','healer'],b:[8,16],th:'lava'},
  {n:'å¹½çµæ£®æ—',w:18,p:[[0,2],[2,2],[2,0],[5,0],[5,3],[7,3],[7,5]],e:['normal','ghost','split','healer'],b:[9,18],th:'dark'},
  {n:'æœºæ¢°å ¡å’',w:20,p:[[0,1],[3,1],[3,3],[1,3],[1,5],[6,5],[6,2],[9,2]],e:['normal','tank','fast','ghost','split'],b:[10,20],th:'metal'},
  {n:'æ²™æ¼ é—è¿¹',w:22,p:[[0,3],[3,3],[3,1],[5,1],[5,4],[8,4],[8,2],[10,2]],e:['fast','tank','ghost','healer'],b:[11,22],th:'desert'},
  {n:'æ·±æµ·ç¥æ®¿',w:24,p:[[0,2],[2,2],[2,4],[4,4],[4,1],[7,1],[7,4],[10,4]],e:['tank','ghost','healer','split','fast'],b:[12,24],th:'ocean'},
  {n:'ç»ˆæè¯•ç‚¼',w:28,p:[[0,1],[2,1],[2,3],[4,3],[4,0],[6,0],[6,4],[8,4],[8,2],[10,2]],e:['normal','fast','tank','ghost','split','healer'],b:[10,18,28],th:'chaos'}
];

const THEMES={
  grass:{bg:'#3a7d28',path:'#8B7355',accent:'#4a9d38'},
  ice:{bg:'#2a5a7a',path:'#a0c0d0',accent:'#4a8aaa'},
  lava:{bg:'#4a2a1a',path:'#6a4a3a',accent:'#8a3a1a'},
  dark:{bg:'#1a2a1a',path:'#3a4a3a',accent:'#2a3a2a'},
  metal:{bg:'#3a3a4a',path:'#6a6a7a',accent:'#5a5a6a'},
  desert:{bg:'#8a7a5a',path:'#a09070',accent:'#9a8a6a'},
  ocean:{bg:'#1a4a6a',path:'#2a6a8a',accent:'#3a5a7a'},
  chaos:{bg:'#2a1a3a',path:'#5a3a6a',accent:'#4a2a5a'}
};

let G,cv,cx;

class Game{
  constructor(){
    cv=document.getElementById('canvas');
    cx=cv.getContext('2d');
    this.st='menu';this.diff=1;this.lv=0;this.unlocked=1;this.stars=Array(8).fill(0);
    this.gw=11;this.gh=6;this.cs=60;
    this.resize();
    this.input();
    this.buildBar();
    this.lvlSel();
    window.onresize=()=>this.resize();
  }
  
  resize(){
    const w=document.getElementById('gameWrap'),r=w.getBoundingClientRect();
    const mw=(r.width-20)/this.gw,mh=(r.height-20)/this.gh;
    this.cs=Math.floor(Math.min(mw,mh,65));
    cv.width=this.cs*this.gw;cv.height=this.cs*this.gh;
    cv.style.width=cv.width+'px';cv.style.height=cv.height+'px';
    if(this.st==='play')this.draw();
  }
  
  input(){
    const h=(e)=>{
      if(this.st!=='play')return;
      e.preventDefault();
      const r=cv.getBoundingClientRect(),t=e.changedTouches?e.changedTouches[0]:e;
      const x=(t.clientX-r.left)*(cv.width/r.width),y=(t.clientY-r.top)*(cv.height/r.height);
      this.click(x,y);
    };
    
    cv.onclick=h;
    cv.ontouchend=h;
  }
  
  click(x,y){
    const c=Math.floor(x/this.cs),r=Math.floor(y/this.cs);
    const tw=this.towers.find(t=>t.c===c&&t.r===r);
    if(tw){
      this.selTower(tw);
      return;
    }
    const ob=this.obs.find(o=>o.c===c&&o.r===r);
    if(ob){
      this.hitObs(ob);
      this.selType = null;
      document.querySelectorAll('.towerCard').forEach(d=>d.classList.remove('selected'));
      return;
    }
    if(this.selType&&this.canBuild(c,r)){
      this.build(c,r);
      this.selType = null;
      document.querySelectorAll('.towerCard').forEach(d=>d.classList.remove('selected'));
    }
    this.desel();
  }
  
  canBuild(c,r){
    if(c<0||c>=this.gw||r<0||r>=this.gh)return false;
    if(this.obs.some(o=>o.c===c&&o.r===r))return false;
    if(this.towers.some(t=>t.c===c&&t.r===r))return false;
    return!this.onPath(c,r);
  }
  
  onPath(c,r){
    for(let i=0;i<this.path.length-1;i++){
      const[x1,y1]=this.path[i],[x2,y2]=this.path[i+1];
      const mnX=Math.min(x1,x2)-.6,mxX=Math.max(x1,x2)+.6;
      const mnY=Math.min(y1,y2)-.6,mxY=Math.max(y1,y2)+.6;
      if(c>=mnX&&c<=mxX&&r>=mnY&&r<=mxY)return true;
    }
    return false;
  }
  
  build(c,r){
    const tp=TOWERS[this.selType];
    if(this.gold<tp.c){this.fTxt('é‡‘å¸ä¸è¶³!',c*this.cs+this.cs/2,r*this.cs,'#ff6b6b');return}
    this.gold-=tp.c;
    this.towers.push({
      c,r,x:c*this.cs+this.cs/2,y:r*this.cs+this.cs/2,
      type:this.selType,...tp,lv:1,cd:0,ang:0,aCh:0
    });
    this.fTxt(tp.i,c*this.cs+this.cs/2,r*this.cs-15,'#fff');
    this.parts(c*this.cs+this.cs/2,r*this.cs+this.cs/2,'#fff',10);
    this.ui();
  }
  
  selTower(t){
    this.selTw=t;this.selType=null;
    document.querySelectorAll('.towerCard').forEach(d=>d.classList.remove('selected'));
    const p=document.getElementById('actPanel'),r=cv.getBoundingClientRect(),
          ar=document.getElementById('gameWrap').getBoundingClientRect();
    const sx=(t.x/cv.width)*r.width+r.left-ar.left,sy=(t.y/cv.height)*r.height+r.top-ar.top;
    p.style.left=sx+'px';p.style.top=(sy-90)+'px';p.style.display='flex';
    const uc=Math.floor(t.c*(.5+t.lv*.25)),sv=Math.floor(t.c*(.25+t.lv*.08));
    document.getElementById('upgCost').textContent=t.lv>=5?'MAX':uc;
    document.getElementById('selVal').textContent=sv;
    
    // æ˜¾ç¤ºå¡”çš„è¯¦ç»†ä¿¡æ¯
    const tp=TOWERS[t.type];
    const info = document.getElementById('towerInfo');
    info.style.display='block';
    info.style.left = (t.x + 40) + 'px';
    info.style.top = (t.y - 40) + 'px';
    
    info.innerHTML = `
      <h3>${tp.n} ${tp.i} Lv.${t.lv}</h3>
      <div class="stat"><span>ä¼¤å®³:</span><span>${Math.floor(t.d)}</span></div>
      <div class="stat"><span>èŒƒå›´:</span><span>${Math.floor(t.r)}</span></div>
      <div class="stat"><span>æ”»å‡»é€Ÿåº¦:</span><span>${Math.round(1000/t.rt)/10}/ç§’</span></div>
      <div class="stat"><span>ä¸‹ä¸€çº§:</span><span>${t.lv<5?uc+'ğŸ’°':'MAX'}</span></div>
      <div style="margin-top:5px;font-size:10px;color:rgba(255,255,255,0.6)">${tp.desc}</div>
    `;
  }
  
  desel(){
    this.selTw=null;
    document.getElementById('actPanel').style.display='none';
    document.getElementById('towerInfo').style.display='none';
  }
  
  hitObs(o){
    if(this.gold<15){this.fTxt('é‡‘å¸ä¸è¶³!',o.c*this.cs+this.cs/2,o.r*this.cs,'#ff6b6b');return}
    this.gold-=15;
    const d=30+Math.random()*20;o.hp-=d;
    this.dTxt(d,o.c*this.cs+this.cs/2,o.r*this.cs+this.cs/2,false);
    this.parts(o.c*this.cs+this.cs/2,o.r*this.cs+this.cs/2,'#8B4513',5);
    if(o.hp<=0){
      const rw=o.gem?o.rw*2:o.rw;
      this.gold+=rw;
      this.fTxt('+'+rw,o.c*this.cs+this.cs/2,o.r*this.cs+this.cs/2,'#FFD700');
      this.parts(o.c*this.cs+this.cs/2,o.r*this.cs+this.cs/2,o.gem?'#FF69B4':'#8B4513',15);
      this.obs=this.obs.filter(x=>x!==o);
    }
    this.ui();
  }
  
  start(i){
    this.lv=i;const L=LEVELS[i];
    ['menuScreen','overScreen','winScreen'].forEach(x=>document.getElementById(x).classList.add('hide'));
    document.getElementById('pauseMenu').style.display='none';
    this.reset(L);this.st='play';this.resize();
    this.wavePreview();this.lt=performance.now();
    requestAnimationFrame(t=>this.loop(t));
  }
  
  retry(){this.start(this.lv)}
  
  reset(L){
    const dm=[1.4,1,.7][this.diff],hm=[.7,1,1.4][this.diff];
    this.gold=Math.floor(300*dm);this.lives=20;
    this.wave=0;this.maxW=L.w;this.path=L.p;this.lvE=L.e;this.bossW=L.b;this.theme=THEMES[L.th];
    this.towers=[];this.enemies=[];this.bullets=[];this.particles=[];this.obs=[];this.lt2=[];
    this.spawn=[];this.combo=0;this.cTm=0;this.maxC=0;this.kills=0;
    this.selType=null;this.selTw=null;this.spd=1;this.wDel=0;this.sTm=0;
    this.skills=[{cd:0,mx:550,ct:50},{cd:0,mx:450,ct:40},{cd:0,mx:650,ct:0}];
    this.x2g=false;this.tBf=0;this.hpMod=hm;
    this.waveStarted=false; // æ–°å¢ï¼šæ ‡è®°æ³¢æ¬¡æ˜¯å¦å·²ç»çœŸæ­£å¼€å§‹
    this.genObs();
    document.getElementById('lvlName').textContent='ç¬¬'+(this.lv+1)+'å…³: '+L.n;
    this.ui();this.skUI();
  }
  
  genObs(){
    const n=2+Math.floor(Math.random()*3);
    for(let i=0;i<n;i++){
      let c,r,t=0;
      do{c=Math.floor(Math.random()*this.gw);r=Math.floor(Math.random()*this.gh);t++}
      while(t<30&&(this.onPath(c,r)||this.obs.some(o=>o.c===c&&o.r===r)));
      if(t<30)this.obs.push({c,r,hp:150,mhp:150,rw:45+Math.floor(Math.random()*35),gem:Math.random()>.7});
    }
  }
  
  loop(ts){
    if(this.st!=='play'&&this.st!=='pause')return;
    if(this.st==='pause'){requestAnimationFrame(t=>this.loop(t));return}
    const dt=Math.min((ts-this.lt)/16.67,3)*this.spd;this.lt=ts;
    this.update(dt);this.draw();
    requestAnimationFrame(t=>this.loop(t));
  }
  
  update(dt){
    this.skills.forEach((s,i)=>{if(s.cd>0){s.cd-=dt;this.skCD(i)}});
    if(this.tBf>0)this.tBf-=dt;
    if(this.cTm>0){this.cTm-=dt;if(this.cTm<=0){this.combo=0;document.getElementById('comboBox').classList.remove('show')}}
    if(this.wDel>0){this.wDel-=dt;return}
    
    // ç”Ÿæˆæ•Œäºº
    if(this.spawn.length){
      this.waveStarted=true; // æ³¢æ¬¡å·²å¼€å§‹
      this.sTm+=dt;
      const rate=this.spawn[0].bs?70:28;
      if(this.sTm>=rate){
        this.spawnE(this.spawn.shift());
        this.sTm=0;
      }
    }else if(!this.enemies.length && this.waveStarted && this.wave<this.maxW){
      // åªæœ‰åœ¨æ³¢æ¬¡çœŸæ­£å¼€å§‹ä¸”æ•Œäººå…¨éƒ¨æ¶ˆç­åæ‰è¿›å…¥ä¸‹ä¸€æ³¢
      this.wave++;
      this.x2g=false;
      this.waveStarted=false;
      this.wavePreview();
    }else if(!this.enemies.length && !this.spawn.length && this.waveStarted && this.wave>=this.maxW){
      // ç¡®ä¿æœ€åä¸€æ³¢çš„æ‰€æœ‰æ•Œäººéƒ½è¢«æ¶ˆç­æ‰èƒœåˆ©
      this.win();
    }
    
    const bm=this.tBf>0?1.6:1;
    // æ•Œäºº
    for(let i=this.enemies.length-1;i>=0;i--){
      const e=this.enemies[i];this.updE(e,dt);
      if(e.done){this.lives-=e.bs?5:1;this.enemies.splice(i,1);this.shake();this.combo=0;if(this.lives<=0)this.lose()}
      else if(e.hp<=0){
        this.killE(e);this.enemies.splice(i,1);
        if(e.sp&&!e.ch){
          for(let j=0;j<2;j++){
            const c=this.mkE(ENEMIES.normal);
            c.x=e.x+(Math.random()-.5)*25;c.y=e.y+(Math.random()-.5)*25;
            c.pi=e.pi;c.nt=e.nt;c.ch=1;c.hp=40*this.hpMod;c.mhp=40*this.hpMod;
            this.enemies.push(c);
          }
        }
      }
    }
    // å¡”
    this.towers.forEach(t=>this.updT(t,dt,bm));
    // å­å¼¹
    for(let i=this.bullets.length-1;i>=0;i--){this.updB(this.bullets[i],dt);if(!this.bullets[i].act)this.bullets.splice(i,1)}
    // ç²’å­
    for(let i=this.particles.length-1;i>=0;i--){const p=this.particles[i];p.x+=p.vx*dt;p.y+=p.vy*dt;p.vy+=.12*dt;p.lf-=.035*dt;if(p.lf<=0)this.particles.splice(i,1)}
    // é—ªç”µ
    for(let i=this.lt2.length-1;i>=0;i--){this.lt2[i].lf-=dt;if(this.lt2[i].lf<=0)this.lt2.splice(i,1)}
    this.ui();
  }
  
  spawnE(d){this.enemies.push(this.mkE(d))}
  
  mkE(d){
    const ws=1+this.wave*.07,dm=this.hpMod;
    return{
      x:this.path[0][0]*this.cs+this.cs/2,y:this.path[0][1]*this.cs+this.cs/2,
      pi:0,nt:this.path[1],hp:d.h*ws*dm,mhp:d.h*ws*dm,
      spd:d.s,bSpd:d.s,rw:d.w,i:d.i,bs:d.bs,hl:d.hl,sp:d.sp,gh:d.gh,
      done:0,fz:0,sTm:0,hTm:0
    };
  }
  
  updE(e,dt){
    if(e.fz>0){e.fz-=dt;if(e.fz<=0)e.spd=e.bSpd;return}
    if(e.sTm>0){e.sTm-=dt;if(e.sTm<=0)e.spd=e.bSpd}
    if(e.hl){e.hTm=(e.hTm||0)+dt;if(e.hTm>55){e.hTm=0;this.enemies.forEach(o=>{if(o!==e&&Math.hypot(o.x-e.x,o.y-e.y)<this.cs*1.5)o.hp=Math.min(o.mhp,o.hp+4)})}}
    if(!e.nt)return;
    const tx=e.nt[0]*this.cs+this.cs/2,ty=e.nt[1]*this.cs+this.cs/2;
    const dx=tx-e.x,dy=ty-e.y,ds=Math.hypot(dx,dy),mv=e.spd*dt;
    if(ds<=mv){e.x=tx;e.y=ty;e.pi++;if(e.pi>=this.path.length-1)e.done=1;else e.nt=this.path[e.pi+1]}
    else{e.x+=dx/ds*mv;e.y+=dy/ds*mv}
  }
  
  killE(e){
    let rw=e.rw+Math.floor(this.combo*.6);if(this.x2g)rw*=2;
    this.gold+=rw;this.kills++;this.combo++;this.cTm=85;
    if(this.combo>this.maxC)this.maxC=this.combo;
    if(this.combo>=5){document.getElementById('comboBox').classList.add('show');document.getElementById('vCombo').textContent=this.combo}
    this.fTxt('+'+rw,e.x,e.y,'#FFD700');
    this.parts(e.x,e.y,e.bs?'#ff0000':'#ff6b6b',e.bs?25:10);
  }
  
  updT(t,dt,bm){
    t.cd-=dt;t.aCh=Math.min(1,(t.aCh||0)+dt*.004);
    let tgs=[];
    for(const e of this.enemies){
      if(e.gh&&Math.random()<.2)continue;
      const d=Math.hypot(e.x-t.x,e.y-t.y);
      if(d<=t.r)tgs.push({e,d,pg:e.pi+(1-d/t.r)});
    }
    tgs.sort((a,b)=>b.pg-a.pg);
    if(tgs.length){
      const m=tgs[0].e;t.ang=Math.atan2(m.y-t.y,m.x-t.x);
      if(t.cd<=0){this.fire(t,m,tgs,bm);t.cd=t.rt}
    }
  }
  
  fire(t,m,all,bm){
    const cr=Math.random()<(t.cr||0),dm=(cr?t.d*2.2:t.d)*bm*(1+(t.lv-1)*.35);
    switch(t.t){
      case'single':this.bullets.push({x:t.x,y:t.y,tg:m,dm,cr,t:'single',sp:11,act:1});break;
      case'pierce':this.bullets.push({x:t.x,y:t.y,tg:m,dm,cr,t:'pierce',pc:t.pc,ht:new Set(),sp:11,act:1,vx:Math.cos(t.ang)*11,vy:Math.sin(t.ang)*11});break;
      case'slow':this.bullets.push({x:t.x,y:t.y,tg:m,dm,cr:0,t:'slow',sl:t.sl,sp:9,act:1});break;
      case'aoe':all.forEach(x=>{if(Math.hypot(x.e.x-t.x,x.e.y-t.y)<=t.ao+25){x.e.hp-=dm;this.dTxt(dm,x.e.x,x.e.y,0)}});this.parts(t.x,t.y,'#FF5722',8);break;
      case'splash':this.bullets.push({x:t.x,y:t.y,tg:m,tx:m.x,ty:m.y,dm,cr,t:'splash',sp:t.sp,spR:45,act:1});break;
      case'sniper':m.hp-=dm;this.dTxt(dm,m.x,m.y,cr);this.lt2.push({x1:t.x,y1:t.y,x2:m.x,y2:m.y,lf:12});break;
      case'chain':this.chainAtk(t,m,all,dm);break;
    }
  }
  
  chainAtk(t,f,all,dm){
    let cur=f;const ht=new Set([f]);let cd=dm;
    for(let i=0;i<(t.ch||3);i++){
      cur.hp-=cd;this.dTxt(cd,cur.x,cur.y,0);
      let nx=null,md=110;
      for(const x of all)if(!ht.has(x.e)){const d=Math.hypot(x.e.x-cur.x,x.e.y-cur.y);if(d<md){md=d;nx=x.e}}
      if(nx){this.lt2.push({x1:cur.x,y1:cur.y,x2:nx.x,y2:nx.y,lf:14});ht.add(nx);cur=nx;cd*=.72}else break;
    }
  }
  
  updB(b,dt){
    if(b.t==='pierce'){
      b.x+=b.vx*dt;b.y+=b.vy*dt;
      for(const e of this.enemies){
        if(b.ht.has(e))continue;
        if(Math.hypot(b.x-e.x,b.y-e.y)<22){
          e.hp-=b.dm;this.dTxt(b.dm,e.x,e.y,b.cr);b.ht.add(e);this.parts(b.x,b.y,'#4CAF50',3);
          if(b.ht.size>=b.pc){b.act=0;break}
        }
      }
      if(b.x<-25||b.x>cv.width+25||b.y<-25||b.y>cv.height+25)b.act=0;
    }else{
      if(!b.tg||b.tg.hp<=0){b.act=0;return}
      const tx=b.tx||b.tg.x,ty=b.ty||b.tg.y;
      const dx=tx-b.x,dy=ty-b.y,ds=Math.hypot(dx,dy);
      if(ds<b.sp*dt){
        if(b.t==='splash'){
          this.enemies.forEach(e=>{if(Math.hypot(e.x-b.x,e.y-b.y)<=b.spR){e.hp-=b.dm;this.dTxt(b.dm,e.x,e.y,0)}});
          this.parts(b.x,b.y,'#FF5722',12);
        }else{
          b.tg.hp-=b.dm;this.dTxt(b.dm,b.tg.x,b.tg.y,b.cr);
          if(b.t==='slow'){b.tg.spd=b.tg.bSpd*b.sl;b.tg.sTm=90}
        }
        this.parts(b.x,b.y,b.cr?'#FFD700':'#fff',4);b.act=0;
      }else{b.x+=dx/ds*b.sp*dt;b.y+=dy/ds*b.sp*dt}
    }
  }
  
  wavePreview(){
    const L=LEVELS[this.lv];
    const isBossWave = L.b.includes(this.wave);
    
    if(isBossWave) {
      // BOSSæ³¢æ¬¡è­¦å‘Šæ—¶é—´å»¶é•¿
      this.bossWarn(this.wave===L.w);
    }
    if(Math.random()<.22)this.randEvt();
    document.getElementById('waveN').textContent=this.wave;
    document.getElementById('waveD').textContent=isBossWave?'BOSSæ¥è¢­!':['å‡†å¤‡è¿æˆ˜!','æ•Œäººæ¥è¢­!','åšå®ˆé˜µåœ°!','å…¨åŠ›ä»¥èµ´!'][Math.floor(Math.random()*4)];
    const es=this.genWave(),con=document.getElementById('waveE');
    con.innerHTML='';const seen=new Set();
    es.slice(0,6).forEach(e=>{if(!seen.has(e.i)){seen.add(e.i);const s=document.createElement('span');s.className='ei';s.textContent=e.i;con.appendChild(s)}});
    document.getElementById('wavePop').style.display='block';
    
    setTimeout(()=>{
      document.getElementById('wavePop').style.display='none';
      this.prepWave();
    },isBossWave?2000:1200); // BOSSæ³¢æ¬¡é¢„å‘Šæ—¶é—´æ›´é•¿
    
    this.wDel=isBossWave?80:60; // BOSSæ³¢æ¬¡ç­‰å¾…æ—¶é—´æ›´é•¿
  }
  
  genWave(){
    const L=LEVELS[this.lv],dm=[.8,1,1.25][this.diff],ib=L.b.includes(this.wave),arr=[];
    if(ib){
      const b={...ENEMIES.boss};
      b.h*=(1+this.lv*.3)*dm;
      if(this.wave===L.w){b.h*=1.6;b.i='ğŸ‰';b.w=450}
      arr.push(b);
    }
    const cnt=Math.floor((5+this.wave*1.1+(this.lv*.8))*dm);
    for(let i=0;i<cnt;i++){const k=L.e[Math.floor(Math.random()*L.e.length)];arr.push({...ENEMIES[k]})}
    return arr;
  }
  
  prepWave(){
    this.spawn=this.genWave();
    const bs=this.spawn.filter(x=>x.bs),ot=this.spawn.filter(x=>!x.bs);
    for(let i=ot.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[ot[i],ot[j]]=[ot[j],ot[i]]}
    this.spawn=[...ot,...bs];
  }
  
  bossWarn(f){
    document.querySelector('#bossWarn .txt').textContent=f?'ğŸ‰ æœ€ç»ˆBOSS ğŸ‰':'âš ï¸ BOSS âš ï¸';
    document.getElementById('bossWarn').style.display='block';
    setTimeout(()=>document.getElementById('bossWarn').style.display='none',f?2500:1800); // æœ€ç»ˆBOSSè­¦å‘Šæ›´é•¿
  }
  
  randEvt(){
    const evts=[
      {n:'ğŸ’° åŒå€é‡‘å¸',d:'æœ¬æ³¢å‡»æ€å¥–åŠ±ç¿»å€!',e:'x2g'},
      {n:'âš¡ æ”»å‡»å¼ºåŒ–',d:'æ‰€æœ‰å¡”æ”»å‡»+60%!',e:'tBf'},
      {n:'â„ï¸ æ•Œäººå‡é€Ÿ',d:'æ•Œäººé€Ÿåº¦é™ä½50%!',e:'slow'},
      {n:'ğŸ’– ç”Ÿå‘½æ¢å¤',d:'æ¢å¤4ç‚¹ç”Ÿå‘½!',e:'heal'}
    ];
    const ev=evts[Math.floor(Math.random()*evts.length)];
    document.getElementById('evtT').textContent=ev.n;
    document.getElementById('evtD').textContent=ev.d;
    document.getElementById('eventPop').style.display='block';
    setTimeout(()=>document.getElementById('eventPop').style.display='none',1500);
    switch(ev.e){
      case'x2g':this.x2g=true;break;
      case'tBf':this.tBf=1000;break;
      case'slow':this.enemies.forEach(e=>{e.spd*=.5;e.sTm=550});break;
      case'heal':this.lives=Math.min(this.lives+4,20);this.fTxt('+4â¤ï¸',cv.width/2,cv.height/2,'#FF69B4');break;
    }
  }
  
  useSkill(i){
    if(this.st!=='play')return;
    const s=this.skills[i];
    if(s.cd>0){this.fTxt('å†·å´ä¸­!',cv.width/2,cv.height/2,'#ff6b6b');return}
    if(s.ct>0&&this.gold<s.ct){this.fTxt('é‡‘å¸ä¸è¶³!',cv.width/2,cv.height/2,'#ff6b6b');return}
    this.gold-=s.ct;s.cd=s.mx;
    switch(i){
      case 0:this.enemies.forEach(e=>{const d=80+Math.random()*50;e.hp-=d;this.dTxt(d,e.x,e.y,1);this.lt2.push({x1:e.x,y1:-20,x2:e.x,y2:e.y,lf:16})});this.shake();break;
      case 1:this.enemies.forEach(e=>{e.fz=200;e.spd*=.08});break;
      case 2:const b=90+this.wave*15;this.gold+=b;for(let j=0;j<18;j++)setTimeout(()=>this.fTxt('ğŸ’°',Math.random()*cv.width,Math.random()*cv.height,'#FFD700'),j*25);this.fTxt('+'+b+'!',cv.width/2,cv.height/2,'#FFD700');break;
    }
    this.ui();this.skUI();
  }
  
  skUI(){
    document.querySelectorAll('.skillBtn').forEach((b,i)=>{
      const s=this.skills[i],cd=b.querySelector('.cdFill');
      if(s.cd<=0){b.classList.add('ready');cd.style.height='0'}
      else{b.classList.remove('ready');cd.style.height=(s.cd/s.mx*100)+'%'}
    });
  }
  skCD(i){
    const b=document.querySelectorAll('.skillBtn')[i],s=this.skills[i],cd=b.querySelector('.cdFill');
    if(s.cd<=0){b.classList.add('ready');cd.style.height='0'}else cd.style.height=(s.cd/s.mx*100)+'%';
  }
  
  draw(){
    const c=cx,s=this.cs,th=this.theme;
    c.clearRect(0,0,cv.width,cv.height);
    
    // èƒŒæ™¯
    const bg=c.createLinearGradient(0,0,0,cv.height);
    bg.addColorStop(0,th.bg);bg.addColorStop(1,th.accent);
    c.fillStyle=bg;c.fillRect(0,0,cv.width,cv.height);
    
    // çº¹ç†
    c.fillStyle='rgba(0,0,0,.06)';
    for(let i=0;i<35;i++){c.beginPath();c.arc((i*71)%cv.width,(i*47)%cv.height,12+(i%7),0,Math.PI*2);c.fill()}
    
    // ç½‘æ ¼(è½»å¾®)
    c.strokeStyle='rgba(255,255,255,.03)';c.lineWidth=1;
    for(let x=0;x<=this.gw;x++){c.beginPath();c.moveTo(x*s,0);c.lineTo(x*s,cv.height);c.stroke()}
    for(let y=0;y<=this.gh;y++){c.beginPath();c.moveTo(0,y*s);c.lineTo(cv.width,y*s);c.stroke()}
    
    // è·¯å¾„
    c.lineCap='round';c.lineJoin='round';
    c.lineWidth=s*.58;c.strokeStyle='rgba(0,0,0,.25)';this.drawPath(c);c.stroke();
    c.lineWidth=s*.52;c.strokeStyle=th.path;this.drawPath(c);c.stroke();
    
    const lg=c.createLinearGradient(0,0,cv.width,0);
    lg.addColorStop(0,'rgba(255,255,255,.15)');lg.addColorStop(.5,'rgba(255,255,255,.25)');lg.addColorStop(1,'rgba(255,255,255,.15)');
    c.lineWidth=s*.42;c.strokeStyle=lg;this.drawPath(c);c.stroke();
    
    c.lineWidth=s*.32;c.strokeStyle='rgba(255,255,255,.1)';this.drawPath(c);c.stroke();
    
    // èåœ
    const ep=this.path[this.path.length-1],ex=ep[0]*s+s/2,ey=ep[1]*s+s/2;
    const rg=c.createRadialGradient(ex,ey,0,ex,ey,s*.7);
    rg.addColorStop(0,'rgba(255,200,0,.5)');rg.addColorStop(1,'transparent');
    c.fillStyle=rg;c.beginPath();c.arc(ex,ey,s*.7,0,Math.PI*2);c.fill();
    c.font=s*.75+'px sans-serif';c.textAlign='center';c.textBaseline='middle';c.fillText('ğŸ¥•',ex,ey);
    
    // éšœç¢ç‰©
    this.obs.forEach(o=>{
      const ox=o.c*s+s/2,oy=o.r*s+s/2;
      c.font=s*.55+'px sans-serif';c.fillText(o.gem?'ğŸ’':'ğŸª¨',ox,oy);
      const bw=s*.5;
      c.fillStyle='rgba(0,0,0,.6)';c.fillRect(ox-bw/2,oy-s*.42,bw,6);
      c.fillStyle=o.gem?'#FF69B4':'#8B4513';c.fillRect(ox-bw/2+1,oy-s*.42+1,(bw-2)*Math.max(0,o.hp/o.mhp),4);
    });
    
    // å¡”
    this.towers.forEach(t=>this.drawT(c,t,s));
    // æ•Œäºº
    this.enemies.forEach(e=>this.drawE(c,e,s));
    // å­å¼¹
    this.bullets.forEach(b=>this.drawB(c,b));
    // é—ªç”µ
    this.lt2.forEach(l=>this.drawL(c,l));
    // ç²’å­
    this.particles.forEach(p=>{c.globalAlpha=Math.max(0,p.lf);c.fillStyle=p.cl;c.beginPath();c.arc(p.x,p.y,p.sz,0,Math.PI*2);c.fill();c.globalAlpha=1});
    // é€‰ä¸­
    if(this.selTw){
      c.beginPath();c.arc(this.selTw.x,this.selTw.y,this.selTw.r,0,Math.PI*2);
      c.fillStyle='rgba(255,255,255,.08)';c.fill();
      c.strokeStyle='rgba(255,255,255,.35)';c.lineWidth=2;c.setLineDash([6,6]);c.stroke();c.setLineDash([]);
    }
  }
  
  drawPath(c){c.beginPath();const p=this.path,s=this.cs;c.moveTo(p[0][0]*s+s/2,p[0][1]*s+s/2);for(let i=1;i<p.length;i++)c.lineTo(p[i][0]*s+s/2,p[i][1]*s+s/2)}
  
  drawT(c,t,s){
    c.save();c.translate(t.x,t.y);
    
    // æ ¹æ®å¡”ç±»å‹è®¾ç½®ä¸åŒé¢œè‰²
    let baseColor, highlightColor;
    switch(t.type) {
      case 'bottle': baseColor = '#4CAF50'; highlightColor = '#8BC34A'; break;
      case 'fan': baseColor = '#2196F3'; highlightColor = '#64B5F6'; break;
      case 'ice': baseColor = '#03A9F4'; highlightColor = '#81D4FA'; break;
      case 'fire': baseColor = '#FF5722'; highlightColor = '#FF8A65'; break;
      case 'cannon': baseColor = '#795548'; highlightColor = '#A1887F'; break;
      case 'magic': baseColor = '#9C27B0'; highlightColor = '#BA68C8'; break;
      default: baseColor = '#555'; highlightColor = '#777';
    }
    
    // å¡”åŸºåº§
    c.fillStyle='rgba(0,0,0,.25)';c.beginPath();c.ellipse(0,s*.06,s*.36,s*.13,0,0,Math.PI*2);c.fill();
    
    // å¡”èº« - ä½¿ç”¨æ¸å˜æ•ˆæœ
    const tg=c.createRadialGradient(0,-5,0,0,0,s*.38);
    tg.addColorStop(0,highlightColor);tg.addColorStop(1,baseColor);
    c.fillStyle=tg;c.beginPath();c.arc(0,0,s*.36,0,Math.PI*2);c.fill();
    
    // è¾¹æ¡†
    c.strokeStyle='rgba(255,255,255,.3)';c.lineWidth=2;c.stroke();
    
    // å¡”å›¾æ ‡
    c.rotate(t.ang+Math.PI/2);c.font=s*.48+'px sans-serif';c.textAlign='center';c.textBaseline='middle';c.fillText(t.i,0,0);
    c.restore();
    
    // ç­‰çº§æ˜Ÿæ˜Ÿ
    if(t.lv>1){
      c.fillStyle='#FFD700';c.font=s*.16+'px sans-serif';c.textAlign='center';
      c.fillText('â­'.repeat(Math.min(t.lv-1,4)),t.x,t.y-s*.48);
    }
    
    // å……èƒ½æ•ˆæœ
    if(t.aCh>=1){
      c.strokeStyle='rgba(255,215,0,.55)';c.lineWidth=2;c.setLineDash([5,5]);
      c.beginPath();c.arc(t.x,t.y,s*.44,0,Math.PI*2);c.stroke();c.setLineDash([]);
    }
  }
  
  drawE(c,e,s){
    const r=e.bs?s*.42:s*.26;
    c.fillStyle='#333';c.beginPath();c.ellipse(e.x,e.y+r*.65,r*.65,r*.22,0,0,Math.PI*2);c.fill();
    if(e.fz>0){c.fillStyle='rgba(100,200,255,1)';c.beginPath();c.arc(e.x,e.y,r+6,0,Math.PI*2);c.fill()}
    c.font=(e.bs?r*2:r*1.85)+'px sans-serif';c.textAlign='center';c.textBaseline='middle';c.fillText(e.i,e.x,e.y);
    const bw=e.bs?r*1.9:r*1.45;
    c.fillStyle='#000';c.fillRect(e.x-bw/2,e.y-r-11,bw,7);
    c.fillStyle='#ef5350';c.fillRect(e.x-bw/2+1,e.y-r-10,bw-2,5);
    c.fillStyle='#66bb6a';c.fillRect(e.x-bw/2+1,e.y-r-10,(bw-2)*Math.max(0,e.hp/e.mhp),5);
  }
  
  drawB(c,b){
    let cl='#FFEB3B',sz=5;
    if(b.t==='slow'){cl='#00BCD4';sz=6}
    if(b.t==='pierce')cl='#4CAF50';
    if(b.t==='splash'){cl='#FF5722';sz=7}
    if(b.cr){cl='#FFD700';sz=8}
    c.shadowColor=cl;c.shadowBlur=10;c.fillStyle=cl;
    c.beginPath();c.arc(b.x,b.y,sz,0,Math.PI*2);c.fill();c.shadowBlur=0;
  }
  
  drawL(c,l){
    c.strokeStyle=`rgba(255,255,150,${l.lf/12})`;c.lineWidth=2;
    c.beginPath();c.moveTo(l.x1,l.y1);
    let x=l.x1,y=l.y1;
    for(let i=0;i<6;i++){x+=(l.x2-l.x1)/6+(Math.random()-.5)*22;y+=(l.y2-l.y1)/6;c.lineTo(x,y)}
    c.stroke();
    c.strokeStyle=`rgba(255,255,255,${l.lf/18})`;c.lineWidth=4;c.stroke();
  }
  
  buildBar(){
    const br=document.getElementById('buildBar');br.innerHTML='';
    for(const k in TOWERS){
      const t=TOWERS[k],d=document.createElement('div');d.className='towerCard';
      d.innerHTML=`<span class="tIcon">${t.i}</span><span class="tCost">${t.c}</span><span class="tName">${t.n}</span>`;
      d.onclick=()=>{
        if(this.gold<t.c)return;
        this.selType=k;
        this.desel();
        document.querySelectorAll('.towerCard').forEach(x=>x.classList.remove('selected'));
        d.classList.add('selected');
      };
      br.appendChild(d);
    }
  }
  
  lvlSel(){
    const g=document.getElementById('lvlGrid');g.innerHTML='';
    LEVELS.forEach((l,i)=>{
      const b=document.createElement('div');b.className='lvlBtn'+(i>=this.unlocked?' locked':'');
      const st=this.stars[i]>0?'â­'.repeat(this.stars[i]):'â˜†â˜†â˜†';
      b.innerHTML=`<div class="num">${i+1}</div><div class="lname">${l.n}</div><div class="stars">${i<this.unlocked?st:'ğŸ”’'}</div>`;
      b.onclick=()=>{if(i<this.unlocked)this.start(i)};
      g.appendChild(b);
    });
  }
  
  ui(){
    document.getElementById('vGold').textContent=Math.floor(this.gold);
    document.getElementById('vLives').textContent=this.lives;
    document.getElementById('vWave').textContent=this.wave;
    document.getElementById('vMaxW').textContent=this.maxW;
    document.getElementById('vKills').textContent=this.kills;
    let i=0;document.querySelectorAll('.towerCard').forEach(d=>{const k=Object.keys(TOWERS)[i];d.classList.toggle('disabled',this.gold<TOWERS[k].c);i++});
  }
  
  fTxt(t,x,y,cl){
    const d=document.createElement('div');d.className='floatTxt';d.textContent=t;d.style.color=cl;d.style.fontSize='18px';
    const r=cv.getBoundingClientRect(),ar=document.getElementById('gameWrap').getBoundingClientRect();
    d.style.left=(x/cv.width*r.width+r.left-ar.left)+'px';
    d.style.top=(y/cv.height*r.height+r.top-ar.top)+'px';
    document.getElementById('gameWrap').appendChild(d);setTimeout(()=>d.remove(),800);
  }
  
  dTxt(dm,x,y,cr){
    const d=document.createElement('div');d.className='dmgTxt';d.textContent=cr?'ğŸ’¥'+Math.floor(dm):'-'+Math.floor(dm);
    d.style.color=cr?'#FFD700':'#ff6b6b';d.style.fontSize=cr?'18px':'13px';d.style.textShadow=cr?'0 0 10px #f00':'none';
    const r=cv.getBoundingClientRect(),ar=document.getElementById('gameWrap').getBoundingClientRect();
    d.style.left=(x/cv.width*r.width+r.left-ar.left+(Math.random()-.5)*18)+'px';
    d.style.top=(y/cv.height*r.height+r.top-ar.top)+'px';
    document.getElementById('gameWrap').appendChild(d);setTimeout(()=>d.remove(),500);
  }
  
  parts(x,y,cl,n){for(let i=0;i<n;i++)this.particles.push({x,y,cl,vx:(Math.random()-.5)*5.5,vy:(Math.random()-.5)*5.5,sz:2.5+Math.random()*3,lf:1})}
  
  shake(){const c=document.getElementById('app');c.style.transform=`translate(${Math.random()*7-3.5}px,${Math.random()*7-3.5}px)`;setTimeout(()=>c.style.transform='none',55)}
  
  win(){
    this.st='win';let st=1;if(this.lives>=10)st=2;if(this.lives>=16)st=3;
    if(st>this.stars[this.lv])this.stars[this.lv]=st;
    if(this.lv+1>=this.unlocked&&this.lv<LEVELS.length-1)this.unlocked=this.lv+2;
    document.getElementById('wKills').textContent=this.kills;
    document.getElementById('wLives').textContent=this.lives;
    document.getElementById('wStars').textContent='â­'.repeat(st)+'â˜†'.repeat(3-st);
    document.getElementById('winScreen').classList.remove('hide');
  }
  
  lose(){
    this.st='over';
    document.getElementById('oKills').textContent=this.kills;
    document.getElementById('oWave').textContent=this.wave;
    document.getElementById('overScreen').classList.remove('hide');
  }
}

function pause(){
  if(G.st==='play'){G.st='pause';document.getElementById('pauseMenu').style.display='flex'}
  else if(G.st==='pause'){G.st='play';document.getElementById('pauseMenu').style.display='none';G.loop(performance.now())}
}
function setSpd(s){G.spd=s;document.querySelectorAll('.cBtn').forEach((b,i)=>{if(i<2)b.classList.toggle('on',i+1===s)})}
function setDiff(d){G.diff=d;document.querySelectorAll('.diffBtn').forEach((b,i)=>b.classList.toggle('sel',i===d))}
function toMenu(){
  G.st='menu';document.getElementById('pauseMenu').style.display='none';
  ['overScreen','winScreen'].forEach(x=>document.getElementById(x).classList.add('hide'));
  document.getElementById('menuScreen').classList.remove('hide');G.lvlSel();
}
function nextLvl(){if(G.lv<LEVELS.length-1)G.start(G.lv+1);else toMenu()}
function doUpgrade(){
  if(!G.selTw)return;const t=G.selTw;
  if(t.lv>=5){G.fTxt('å·²æ»¡çº§!',t.x,t.y,'#FFD700');return}
  const c=Math.floor(t.c*(.5+t.lv*.25));
  if(G.gold>=c){
    G.gold-=c;t.lv++;
    t.d=TOWERS[t.type].d*(1+t.lv*.4);
    t.r=TOWERS[t.type].r*(1+t.lv*.1);
    t.rt=TOWERS[t.type].rt*Math.pow(.88,t.lv-1);
    G.fTxt('â¬†ï¸Lv.'+t.lv,t.x,t.y,'#2ED573');
    G.parts(t.x,t.y,'#FFD700',12);
    G.selTower(t);
    G.ui();
  }
  else G.fTxt('é‡‘å¸ä¸è¶³!',t.x,t.y,'#ff6b6b');
}
function doSell(){
  if(!G.selTw)return;const t=G.selTw,v=Math.floor(t.c*(.25+t.lv*.08));
  G.gold+=v;G.towers=G.towers.filter(x=>x!==t);G.fTxt('+'+v,t.x,t.y,'#FFD700');G.parts(t.x,t.y,'#888',10);G.desel();G.ui();
}
function doAbility(){
  if(!G.selTw)return;const t=G.selTw;
  if(t.aCh<1){G.fTxt('å……èƒ½ä¸­...',t.x,t.y,'#888');return}
  t.aCh=0;
  const ab={
    bottle:()=>{for(let i=0;i<6;i++)setTimeout(()=>{const tgs=G.enemies.filter(e=>Math.hypot(e.x-t.x,e.y-t.y)<t.r);if(tgs.length){const tg=tgs[Math.floor(Math.random()*tgs.length)];G.bullets.push({x:t.x,y:t.y,tg,dm:t.d*1.8,cr:1,t:'single',sp:13,act:1})}},i*75);G.fTxt('ğŸ”«è¿å°„!',t.x,t.y-30,'#3498db')},
    fan:()=>{G.enemies.forEach(e=>{const d=Math.hypot(e.x-t.x,e.y-t.y);if(d<t.r*1.4){const a=Math.atan2(t.y-e.y,t.x-e.x);e.x+=Math.cos(a)*30;e.y+=Math.sin(a)*30;e.hp-=t.d*2.5;G.dTxt(t.d*2.5,e.x,e.y,0)}});G.fTxt('ğŸŒ€é¾™å·é£!',t.x,t.y-30,'#2ed573')},
    ice:()=>{G.enemies.forEach(e=>{e.fz=220;e.spd*=.04});G.fTxt('â„ï¸å†°å°!',t.x,t.y-30,'#00BCD4')},
    fire:()=>{G.enemies.forEach(e=>{const d=Math.hypot(e.x-t.x,e.y-t.y);if(d<t.r*1.6){const dm=t.d*5*(1-d/(t.r*1.6));e.hp-=dm;G.dTxt(dm,e.x,e.y,1)}});G.parts(t.x,t.y,'#FF5722',25);G.shake();G.fTxt('ğŸ”¥çƒˆç„°!',t.x,t.y-30,'#FF5722')},
    cannon:()=>{G.enemies.forEach(e=>{e.hp-=t.d*2.5;G.dTxt(t.d*2.5,e.x,e.y,1);G.parts(e.x,e.y,'#FF5722',6)});G.shake();G.fTxt('ğŸ’£è½°ç‚¸!',t.x,t.y-30,'#FF5722')},
    magic:()=>{G.enemies.forEach(e=>{e.hp-=t.d*3.5;G.dTxt(t.d*3.5,e.x,e.y,1);G.parts(e.x,e.y,'#E91E63',6)});G.fTxt('ğŸ”®çˆ†å‘!',t.x,t.y-30,'#E91E63')}
  };
  if(ab[t.type])ab[t.type]();G.desel();
}
function useSkill(i){G.useSkill(i)}

G=new Game();
</script>

</body>
</html>
